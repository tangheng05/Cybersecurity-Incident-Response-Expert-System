{% extends "layouts/base.html" %} {% block title %}Dashboard{% endblock %} {%
block extra_css %}
<style>
  #incidentAnalysisCard .card-header {
    transition: border-radius 0.3s ease;
  }

  #incidentAnalysisCard .card-header[aria-expanded="false"] {
    border-radius: 8px !important;
  }

  #incidentAnalysisCard .card-header[aria-expanded="true"] {
    border-radius: 8px 8px 0 0 !important;
  }

  #incidentAnalysisCard {
    border-radius: 8px;
    overflow: hidden;
  }
</style>
{% endblock %} {% block content %}
<div class="mb-4">
  <h1 class="h2" style="font-weight: 700; color: var(--text-primary)">
    <i class="fas fa-chart-line me-2"></i>Security Dashboard
  </h1>
  <p style="color: var(--text-secondary); font-size: 0.95rem">
    Real-time threat monitoring and incident response
  </p>
</div>

<!-- Analysis Results (if just analyzed) -->
{% if analysis_summary %}
<div
  class="card mb-4"
  style="border: 2px solid {% if analysis_summary.confidence >= 70 %}#10b981{% elif analysis_summary.confidence >= 40 %}#f59e0b{% else %}#ef4444{% endif %}; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);"
>
  <div
    class="card-header"
    style="background: {% if analysis_summary.confidence >= 70 %}#10b981{% elif analysis_summary.confidence >= 40 %}#f59e0b{% else %}#ef4444{% endif %}; color: white;"
  >
    <h5 class="mb-0">
      <i class="fas fa-check-circle me-2"></i>Analysis Complete
    </h5>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <h4 style="color: var(--text-primary)">
          {% if analysis_summary.matched_rules_count > 0 %} üö® Threat Detected:
          <span style="color: #ef4444">{{ analysis_summary.alert_type }}</span>
          {% else %} ‚ÑπÔ∏è No Threats Detected {% endif %}
        </h4>
        <p style="color: var(--text-secondary); margin: 0">
          Source IP: <code>{{ analysis_summary.source_ip }}</code>
        </p>
      </div>
      <div class="col-md-6 text-end">
        <div style="display: inline-block; text-align: center">
          <div
            style="font-size: 3rem; font-weight: 700; color: {% if analysis_summary.confidence >= 70 %}#10b981{% elif analysis_summary.confidence >= 40 %}#f59e0b{% else %}#ef4444{% endif %};"
          >
            {{ analysis_summary.confidence }}%
          </div>
          <div style="color: var(--text-secondary); font-size: 0.9rem">
            Confidence
          </div>
        </div>
      </div>
    </div>

    {% if analysis_summary.matched_rules_count > 0 %}
    <div class="mb-3">
      <h6 style="color: var(--text-primary)">
        <i class="fas fa-shield-alt me-2"></i>Matched {{
        analysis_summary.matched_rules_count }} Security Rule(s)
      </h6>
      <div
        style="
          background: rgba(255, 255, 255, 0.05);
          padding: 1rem;
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1);
        "
      >
        <strong style="color: var(--text-primary)">Recommended Actions:</strong>
        <ul
          style="
            margin: 0.5rem 0 0 0;
            padding-left: 1.5rem;
            color: var(--text-primary);
          "
        >
          {% for action in analysis_summary.recommended_actions %}
          <li>{{ action.replace('_', ' ').title() }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <div class="d-flex gap-2">
      <a
        href="{{ url_for('alerts.detail', alert_id=analysis_summary.alert_id) }}"
        class="btn btn-primary"
      >
        <i class="fas fa-eye me-2"></i>View Full Details
      </a>
      <a href="{{ url_for('alerts.index') }}" class="btn btn-outline-secondary">
        <i class="fas fa-list me-2"></i>Go to Alerts
      </a>
      <a
        href="{{ url_for('dashboard.index') }}"
        class="btn btn-outline-secondary"
      >
        <i class="fas fa-times me-2"></i>Dismiss
      </a>
    </div>
  </div>
</div>
{% endif %}

<!-- Incident Analysis Form -->
<div
  class="card mb-4"
  id="incidentAnalysisCard"
  style="
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    overflow: hidden;
  "
>
  <div
    class="card-header"
    style="
      background: var(--primary-color);
      color: white;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
    "
    data-bs-toggle="collapse"
    data-bs-target="#incidentAnalysisForm"
    aria-expanded="true"
    aria-controls="incidentAnalysisForm"
  >
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-brain me-2"></i>Analyze Security Incident
      </h5>
      <i class="fas fa-chevron-down" id="collapseIcon"></i>
    </div>
  </div>
  <div class="collapse show" id="incidentAnalysisForm">
    <div class="card-body">
      <form method="POST" action="{{ url_for('dashboard.index') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Source IP Address</label>
            <input
              type="text"
              name="source_ip"
              id="source_ip"
              class="form-control"
              placeholder="e.g., 192.168.1.100"
              required
            />
          </div>
          <div class="col-md-6">
            <label class="form-label">Severity Level</label>
            <select name="severity" id="severity" class="form-control" required>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Failed Login Attempts</label>
            <input
              type="number"
              name="failed_attempts"
              id="failed_attempts"
              class="form-control"
              placeholder="e.g., 5"
              min="0"
            />
            <small class="text-muted">Leave empty if not applicable</small>
          </div>
          <div class="col-md-6">
            <label class="form-label">Requests Per Second</label>
            <input
              type="number"
              name="requests_per_second"
              id="requests_per_second"
              class="form-control"
              placeholder="e.g., 10000"
              min="0"
            />
            <small class="text-muted">For traffic-based incidents</small>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Target Service/Endpoint</label>
            <input
              type="text"
              name="target_service"
              id="target_service"
              class="form-control"
              placeholder="e.g., ssh, /api/login"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label">Time Window (seconds)</label>
            <input
              type="number"
              name="time_window"
              id="time_window"
              class="form-control"
              placeholder="e.g., 300"
              min="0"
            />
            <small class="text-muted">Duration of the incident</small>
          </div>
        </div>

        <div class="mb-3">
          <small class="text-muted">üí° Quick fill: </small>
          <button
            type="button"
            class="btn btn-sm btn-outline-primary"
            onclick="loadBruteForce()"
          >
            <i class="fas fa-lock"></i> Brute Force Example
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-danger"
            onclick="loadDDoS()"
          >
            <i class="fas fa-bomb"></i> DDoS Example
          </button>
        </div>

        <button type="submit" class="btn btn-primary btn-lg">
          <i class="fas fa-brain me-2"></i>Analyze Incident
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  // Toggle chevron icon and border-radius on collapse
  const collapseElement = document.getElementById("incidentAnalysisForm");
  const headerElement = document.querySelector(
    "#incidentAnalysisCard .card-header"
  );

  collapseElement.addEventListener("show.bs.collapse", function () {
    document.getElementById("collapseIcon").classList.remove("fa-chevron-down");
    document.getElementById("collapseIcon").classList.add("fa-chevron-up");
    headerElement.setAttribute("aria-expanded", "true");
    headerElement.style.borderRadius = "8px 8px 0 0";
  });

  collapseElement.addEventListener("hide.bs.collapse", function () {
    document.getElementById("collapseIcon").classList.remove("fa-chevron-up");
    document.getElementById("collapseIcon").classList.add("fa-chevron-down");
    headerElement.setAttribute("aria-expanded", "false");
    headerElement.style.borderRadius = "8px";
  });

  function loadBruteForce() {
    document.getElementById("source_ip").value = "192.168.1.100";
    document.getElementById("severity").value = "high";
    document.getElementById("failed_attempts").value = "6";
    document.getElementById("target_service").value = "ssh";
    document.getElementById("time_window").value = "300";
    document.getElementById("requests_per_second").value = "";
  }

  function loadDDoS() {
    document.getElementById("source_ip").value = "10.0.0.50";
    document.getElementById("severity").value = "critical";
    document.getElementById("requests_per_second").value = "15000";
    document.getElementById("target_service").value = "/api/data";
    document.getElementById("failed_attempts").value = "";
    document.getElementById("time_window").value = "";
  }
</script>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-sm-6 col-xl-3 mb-3">
    <div class="stats-card">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: start;
        "
      >
        <div>
          <h6
            style="
              color: var(--text-secondary);
              font-weight: 600;
              margin-bottom: 8px;
              font-size: 0.75rem;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            "
          >
            Active Incidents
          </h6>
          <div class="display-4">{{ active_incidents_count }}</div>
          <small style="color: var(--text-muted); font-size: 0.8rem"
            >New, Analyzing, Pending</small
          >
        </div>
        <div
          style="font-size: 2.5rem; opacity: 0.2; color: var(--danger-color)"
        >
          <i class="fas fa-exclamation-triangle"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3 mb-3">
    <div class="stats-card">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: start;
        "
      >
        <div>
          <h6
            style="
              color: var(--text-secondary);
              font-weight: 600;
              margin-bottom: 8px;
              font-size: 0.75rem;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            "
          >
            Pending Alerts
          </h6>
          <div class="display-4">{{ pending_alerts_count }}</div>
          <small style="color: var(--text-muted); font-size: 0.8rem"
            >Awaiting Analysis</small
          >
        </div>
        <div
          style="font-size: 2.5rem; opacity: 0.2; color: var(--warning-color)"
        >
          <i class="fas fa-bell"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3 mb-3">
    <div class="stats-card">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: start;
        "
      >
        <div>
          <h6
            style="
              color: var(--text-secondary);
              font-weight: 600;
              margin-bottom: 8px;
              font-size: 0.75rem;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            "
          >
            Resolved Today
          </h6>
          <div class="display-4">{{ resolved_today_count }}</div>
          <small style="color: var(--text-muted); font-size: 0.8rem"
            >Incidents Closed</small
          >
        </div>
        <div
          style="font-size: 2.5rem; opacity: 0.2; color: var(--success-color)"
        >
          <i class="fas fa-check-circle"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3 mb-3">
    <div class="stats-card">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: start;
        "
      >
        <div>
          <h6
            style="
              color: var(--text-secondary);
              font-weight: 600;
              margin-bottom: 8px;
              font-size: 0.75rem;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            "
          >
            Active Rules
          </h6>
          <div class="display-4">{{ active_rules_count }}</div>
          <small style="color: var(--text-muted); font-size: 0.8rem"
            >Detection Rules</small
          >
        </div>
        <div
          style="font-size: 2.5rem; opacity: 0.2; color: var(--primary-color)"
        >
          <i class="fas fa-shield-alt"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
  <div class="col-sm-6 col-xl-3 mb-3">
    <a
      href="{{ url_for('alerts.index') }}"
      class="btn btn-primary btn-lg w-100"
      style="
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      "
    >
      <i class="fas fa-bell fa-2x mb-2"></i>
      <span>View Alerts</span>
    </a>
  </div>
  <div class="col-sm-6 col-xl-3 mb-3">
    <a
      href="{{ url_for('alerts.create') }}"
      class="btn btn-danger btn-lg w-100"
      style="
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      "
    >
      <i class="fas fa-plus-circle fa-2x mb-2"></i>
      <span>Submit Alert</span>
    </a>
  </div>
  <div class="col-sm-6 col-xl-3 mb-3">
    <a
      href="{{ url_for('rules.index') }}"
      class="btn btn-success btn-lg w-100"
      style="
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      "
    >
      <i class="fas fa-shield-alt fa-2x mb-2"></i>
      <span>Security Rules</span>
    </a>
  </div>
  {% if session.user_role == 'admin' %}
  <div class="col-sm-6 col-xl-3 mb-3">
    <a
      href="{{ url_for('roles.index') }}"
      class="btn btn-primary btn-lg w-100"
      style="
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      "
    >
      <i class="fas fa-user-shield fa-2x mb-2"></i>
      <span>Manage Roles</span>
    </a>
  </div>
  {% endif %}
</div>

<!-- Charts Row -->
<div class="row mb-4">
  <div class="col-lg-6 mb-3">
    <div class="card h-100">
      <div class="card-header">
        <i class="fas fa-chart-pie me-2"></i>Attack Type Distribution
      </div>
      <div class="card-body d-flex justify-content-center align-items-center">
        <div style="width: 100%; max-width: 400px">
          <canvas id="attackTypeChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-3">
    <div class="card h-100">
      <div class="card-header">
        <i class="fas fa-chart-bar me-2"></i>Incident Status
      </div>
      <div class="card-body">
        <div style="position: relative; height: 250px; width: 100%">
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Alerts Feed -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-bell me-2"></i>Recent Alerts
      </div>
      <div class="card-body">
        {% if recent_alerts %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Source IP</th>
                <th>Severity</th>
                <th>Status</th>
                <th>Created</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for alert in recent_alerts %}
              <tr>
                <td>{{ alert.id }}</td>
                <td>{{ alert.alert_type }}</td>
                <td><code>{{ alert.source_ip }}</code></td>
                <td>
                  {% if alert.severity == 'critical' %}
                  <span class="badge bg-danger">Critical</span>
                  {% elif alert.severity == 'high' %}
                  <span class="badge bg-warning">High</span>
                  {% elif alert.severity == 'medium' %}
                  <span class="badge bg-info">Medium</span>
                  {% else %}
                  <span class="badge bg-secondary">Low</span>
                  {% endif %}
                </td>
                <td>
                  {% if alert.status == 'new' %}
                  <span class="badge bg-warning">New</span>
                  {% elif alert.status == 'processed' %}
                  <span class="badge bg-success">Processed</span>
                  {% else %}
                  <span class="badge bg-secondary">Ignored</span>
                  {% endif %}
                </td>
                <td>{{ alert.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                  <a
                    href="{{ url_for('alerts.detail', alert_id=alert.id) }}"
                    class="btn btn-sm btn-outline-primary"
                    >View</a
                  >
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <a href="{{ url_for('alerts.index') }}" class="btn btn-primary"
          >View All Alerts ‚Üí</a
        >
        {% else %}
        <p class="text-muted mb-0">
          No alerts yet. Submit an alert to start analyzing security incidents.
        </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Recent Incidents -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-fire me-2"></i>Recent Incidents
      </div>
      <div class="card-body">
        {% if recent_incidents %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Alert ID</th>
                <th>Attack Type</th>
                <th>Confidence</th>
                <th>Status</th>
                <th>Created</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for incident in recent_incidents %}
              <tr>
                <td>{{ incident.id }}</td>
                <td>
                  <a
                    href="{{ url_for('alerts.detail', alert_id=incident.alert_id) }}"
                    >#{{ incident.alert_id }}</a
                  >
                </td>
                <td>
                  {% if incident.attack_type_id %}
                  <span class="badge bg-warning"
                    >{{ incident.attack_type_id }}</span
                  >
                  {% else %}
                  <span class="badge bg-secondary">Unknown</span>
                  {% endif %}
                </td>
                <td>
                  <span
                    class="badge {% if incident.confidence_score >= 80 %}bg-success{% elif incident.confidence_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                  >
                    {{ incident.confidence_score }}%
                  </span>
                </td>
                <td>
                  {% if incident.status == 'new' %}
                  <span class="badge bg-primary">New</span>
                  {% elif incident.status == 'analyzing' %}
                  <span class="badge bg-info">Analyzing</span>
                  {% elif incident.status == 'pending' %}
                  <span class="badge bg-warning">Pending</span>
                  {% else %}
                  <span class="badge bg-success">Resolved</span>
                  {% endif %}
                </td>
                <td>{{ incident.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                  <a
                    href="{{ url_for('alerts.detail', alert_id=incident.alert_id) }}"
                    class="btn btn-sm btn-outline-primary"
                    >View</a
                  >
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted mb-0">
          No incidents yet. Submit alerts to begin security analysis.
        </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Set Chart.js defaults based on CSS variables
  const style = getComputedStyle(document.body);
  Chart.defaults.color = style.getPropertyValue('--text-secondary').trim();
  Chart.defaults.borderColor = style.getPropertyValue('--card-border').trim();

  // Attack Type Distribution Chart
  const attackTypeCtx = document.getElementById('attackTypeChart').getContext('2d');
  const attackTypeData = {
    labels: [{% for stat in attack_type_stats %}'{{ stat.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
      label: 'Incidents',
      data: [{% for stat in attack_type_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
      backgroundColor: [
        'rgba(255, 99, 132, 0.6)',
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(153, 102, 255, 0.6)'
      ],
      borderColor: [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)'
      ],
      borderWidth: 1
    }]
  };

  new Chart(attackTypeCtx, {
    type: 'pie',
    data: attackTypeData,
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
        }
      }
    }
  });

  // Status Distribution Chart
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  const statusData = {
    labels: [{% for stat in status_stats %}'{{ stat.status|title }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
      label: 'Count',
      data: [{% for stat in status_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
      backgroundColor: [
        'rgba(54, 162, 235, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(75, 192, 75, 0.6)'
      ],
      borderColor: [
        'rgba(54, 162, 235, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 75, 1)'
      ],
      borderWidth: 1
    }]
  };

  new Chart(statusCtx, {
    type: 'bar',
    data: statusData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      },
      barPercentage: 0.5,
      categoryPercentage: 0.8
    }
  });
</script>
{% endblock %}
