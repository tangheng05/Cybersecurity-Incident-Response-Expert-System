{% extends "layouts/base.html" %} {% block title %}Alert #{{ alert.id }} -
Details{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-shield-exclamation"></i> Alert #{{ alert.id }}</h2>
    <div class="d-flex gap-3">
      <a
        href="{{ url_for('alerts.index') }}"
        class="btn btn-outline-secondary"
        style="
          border-radius: 10px;
          padding: 0.65rem 1.5rem;
          font-weight: 500;
          border-width: 2px;
          transition: all 0.3s ease;
        "
      >
        <i class="fas fa-arrow-left me-2"></i>Back to List
      </a>
      {% if session.user_role in ['admin', 'analyst'] %}
      <form
        method="POST"
        action="{{ url_for('alerts.analyze', alert_id=alert.id) }}"
        style="display: inline"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button
          type="submit"
          class="btn btn-outline-warning"
          style="
            border-radius: 10px;
            padding: 0.65rem 1.5rem;
            font-weight: 500;
            border-width: 2px;
            transition: all 0.3s ease;
          "
        >
          <i class="fas fa-sync-alt me-2"></i>Re-Analyze
        </button>
      </form>
      {% if alert.status != 'ignored' %}
      <button
        type="button"
        class="btn btn-outline-danger"
        style="
          border-radius: 10px;
          padding: 0.65rem 1.5rem;
          font-weight: 500;
          border-width: 2px;
          transition: all 0.3s ease;
        "
        onclick="showIgnoreModal()"
      >
        <i class="fas fa-ban me-2"></i>Ignore Alert
      </button>
      {% else %}
      <form
        method="POST"
        action="{{ url_for('alerts.unignore', alert_id=alert.id) }}"
        style="display: inline"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button
          type="submit"
          class="btn btn-outline-success"
          style="
            border-radius: 10px;
            padding: 0.65rem 1.5rem;
            font-weight: 500;
            border-width: 2px;
            transition: all 0.3s ease;
          "
        >
          <i class="fas fa-check-circle me-2"></i>Restore Alert
        </button>
      </form>
      {% endif %} {% endif %}
    </div>
  </div>

  <!-- Custom Ignore Confirmation Modal -->
  <div
    id="ignoreModal"
    style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    "
  >
    <div
      style="
        background: var(--card-bg);
        border-radius: 16px;
        padding: 0;
        max-width: 480px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        overflow: hidden;
      "
    >
      <!-- Modal Header -->
      <div
        style="
          background: linear-gradient(
            135deg,
            rgba(220, 53, 69, 0.1),
            rgba(220, 53, 69, 0.05)
          );
          padding: 1.5rem;
          border-bottom: 2px solid rgba(220, 53, 69, 0.2);
        "
      >
        <div style="display: flex; align-items: center; gap: 12px">
          <div
            style="
              width: 48px;
              height: 48px;
              border-radius: 50%;
              background: rgba(220, 53, 69, 0.15);
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <i
              class="fas fa-exclamation-triangle"
              style="font-size: 1.5rem; color: #dc3545"
            ></i>
          </div>
          <div>
            <h5 style="margin: 0; color: var(--text-primary); font-weight: 700">
              Ignore Alert
            </h5>
            <p
              style="margin: 0; color: var(--text-secondary); font-size: 0.9rem"
            >
              Alert #{{ alert.id }}
            </p>
          </div>
        </div>
      </div>

      <!-- Modal Body -->
      <div style="padding: 1.5rem">
        <p
          style="
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0;
          "
        >
          Are you sure you want to mark this alert as
          <strong style="color: #dc3545">ignored</strong>? This action will
          remove it from active monitoring and move it to the ignored alerts
          list.
        </p>
      </div>

      <!-- Modal Footer -->
      <div
        style="
          padding: 1rem 1.5rem;
          background: rgba(108, 117, 125, 0.05);
          border-top: 1px solid var(--card-border);
          display: flex;
          gap: 12px;
          justify-content: flex-end;
        "
      >
        <button
          type="button"
          onclick="hideIgnoreModal()"
          class="btn btn-outline-secondary"
          style="border-radius: 8px; padding: 0.65rem 1.5rem; font-weight: 500"
        >
          <i class="fas fa-times me-2"></i>Cancel
        </button>
        <form
          method="POST"
          action="{{ url_for('alerts.ignore', alert_id=alert.id) }}"
          style="display: inline; margin: 0"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <button
            type="submit"
            class="btn btn-danger"
            style="
              border-radius: 8px;
              padding: 0.65rem 1.5rem;
              font-weight: 500;
            "
          >
            <i class="fas fa-ban me-2"></i>Yes, Ignore Alert
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    function showIgnoreModal() {
      const modal = document.getElementById("ignoreModal");
      modal.style.display = "flex";
      document.body.style.overflow = "hidden";
    }

    function hideIgnoreModal() {
      const modal = document.getElementById("ignoreModal");
      modal.style.display = "none";
      document.body.style.overflow = "auto";
    }

    // Close modal when clicking outside
    document
      .getElementById("ignoreModal")
      ?.addEventListener("click", function (e) {
        if (e.target === this) {
          hideIgnoreModal();
        }
      });

    // Close modal with Escape key
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        hideIgnoreModal();
      }
    });
  </script>

  <div class="row">
    <!-- Alert Details Card -->
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5><i class="bi bi-info-circle"></i> Alert Information</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="40%">Timestamp:</th>
              <td>{{ alert.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            </tr>
            <tr>
              <th>Source IP:</th>
              <td><code>{{ alert.source_ip }}</code></td>
            </tr>
            <tr>
              <th>Destination IP:</th>
              <td><code>{{ alert.destination_ip or 'N/A' }}</code></td>
            </tr>
            <tr>
              <th>Alert Type:</th>
              <td>{{ alert.alert_type }}</td>
            </tr>
            <tr>
              <th>Severity:</th>
              <td>
                <span
                  class="badge bg-{% if alert.severity == 'critical' %}danger{% elif alert.severity == 'high' %}warning{% elif alert.severity == 'medium' %}info{% else %}secondary{% endif %}"
                >
                  {{ alert.severity.upper() }}
                </span>
              </td>
            </tr>
            <tr>
              <th>Status:</th>
              <td>
                <span
                  class="badge bg-{% if alert.status == 'new' %}primary{% elif alert.status == 'processed' %}success{% else %}secondary{% endif %}"
                >
                  {{ alert.status.upper() }}
                </span>
              </td>
            </tr>
          </table>

          <h6 class="mt-3">Raw Alert Data:</h6>
          <pre
            class="bg-light p-3 rounded"
          ><code>{{ alert.raw_data | tojson(indent=2) }}</code></pre>
        </div>
      </div>
    </div>

    <!-- Analysis Results Card -->
    <div class="col-md-6 mb-4">
      {% if incident %} {% set cf_percent = (incident.final_cf * 100)|int if
      incident.final_cf else 0 %}
      <div
        class="card border-{% if cf_percent >= 80 %}danger{% elif cf_percent >= 60 %}warning{% else %}info{% endif %}"
      >
        <div
          class="card-header bg-{% if cf_percent >= 80 %}danger{% elif cf_percent >= 60 %}warning{% else %}info{% endif %} text-white"
        >
          <h5><i class="bi bi-cpu"></i> Analysis Results</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6>Certainty Factor (CF):</h6>
            <div class="progress" style="height: 30px">
              <div
                class="progress-bar bg-{% if cf_percent >= 80 %}danger{% elif cf_percent >= 60 %}warning{% else %}info{% endif %}"
                role="progressbar"
                style="width: {{ cf_percent }}%"
                aria-valuenow="{{ cf_percent }}"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                {{ "%.2f"|format(incident.final_cf) if incident.final_cf else
                '0.00' }}
              </div>
            </div>
          </div>

          {% if incident.attack_type %}
          <div class="mb-3">
            <h6>Detected Attack Type:</h6>
            <div class="alert alert-danger">
              <strong
                >{{ incident.attack_type.name.replace('_', ' ').title()
                }}</strong
              >
              <p class="mb-0 small">{{ incident.attack_type.description }}</p>
            </div>
          </div>
          {% endif %}

          <div class="mb-3">
            <h6>Recommended Actions:</h6>
            {% if incident.recommended_actions %}
            <ul class="list-group">
              {% for action in incident.recommended_actions %}
              <li class="list-group-item">
                <i class="bi bi-check-circle text-success"></i>
                <strong>{{ action.replace('_', ' ').title() }}</strong>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No recommended actions available.</p>
            {% endif %}
          </div>

          <div class="mb-3">
            <h6>Matched Rules:</h6>
            {% if incident.trace and incident.trace.fired_rules %}
            <p>
              {{ incident.trace.fired_rules | length }} security rule(s) matched
            </p>
            {% else %}
            <p class="text-muted">No rules matched</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Explanation Card -->
      <div class="card mt-3">
        <div class="card-header">
          <h5><i class="bi bi-chat-left-text"></i> Detailed Explanation</h5>
        </div>
        <div class="card-body">
          <p style="white-space: pre-line">{{ incident.explanation }}</p>
        </div>
      </div>
      {% else %}
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> This alert has not been
        analyzed yet. {% if session.user_role in ['admin', 'analyst'] %} Click
        "Re-Analyze" to process it. {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
