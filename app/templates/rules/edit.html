{% extends "layouts/base.html" %} {% block title %}Edit Rule{% endblock %} {%
block content %}
<h1 class="h3 mb-4">Edit Security Rule</h1>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="POST" novalidate id="ruleForm">
      {{ form.hidden_tag() }}

      <!-- Basic Information -->
      <div class="row">
        <div class="col-md-8">
          <div class="mb-3">
            {{ form.name.label(class="form-label") }} {{
            form.name(class="form-control" + (" is-invalid" if form.name.errors
            else "")) }} {% if form.name.errors %}
            <div class="invalid-feedback">
              {% for error in form.name.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            {{ form.attack_type_id.label(class="form-label") }} {{
            form.attack_type_id(class="form-select" + (" is-invalid" if
            form.attack_type_id.errors else "")) }} {% if
            form.attack_type_id.errors %}
            <div class="invalid-feedback">
              {% for error in form.attack_type_id.errors %}{{ error }}{% endfor
              %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Conditions Builder -->
      <div class="mb-4">
        <label class="form-label fw-bold">Conditions</label>
        <small class="text-muted d-block mb-2"
          >Define what triggers this rule</small
        >

        <div id="conditionsContainer">
          <!-- Dynamic conditions will be loaded here -->
        </div>

        <button
          type="button"
          class="btn btn-sm btn-outline-primary"
          id="addConditionBtn"
        >
          <i class="fas fa-plus"></i> Add Condition
        </button>

        {{ form.conditions(class="d-none", id="conditionsJson") }} {% if
        form.conditions.errors %}
        <div class="text-danger small mt-1">
          {% for error in form.conditions.errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- Actions Selector -->
      <div class="mb-4">
        <label class="form-label fw-bold">Recommended Actions</label>
        <small class="text-muted d-block mb-2"
          >Select actions to take when rule matches</small
        >

        <div class="row">
          <div class="col-md-4">
            <div class="form-check mb-2">
              <input
                class="form-check-input action-checkbox"
                type="checkbox"
                value="block_ip"
                id="action_block_ip"
              />
              <label class="form-check-label" for="action_block_ip">
                <i class="fas fa-ban text-danger"></i> Block IP Address
              </label>
            </div>
            <div class="form-check mb-2">
              <input
                class="form-check-input action-checkbox"
                type="checkbox"
                value="block_country"
                id="action_block_country"
              />
              <label class="form-check-label" for="action_block_country">
                <i class="fas fa-globe text-danger"></i> Block Country
              </label>
            </div>
            <div class="form-check mb-2">
              <input
                class="form-check-input action-checkbox"
                type="checkbox"
                value="rate_limit"
                id="action_rate_limit"
              />
              <label class="form-check-label" for="action_rate_limit">
                <i class="fas fa-tachometer-alt text-warning"></i> Rate Limit
              </label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-check mb-2">
              <input
                class="form-check-input action-checkbox"
                type="checkbox"
                value="alert_admin"
                id="action_alert_admin"
              />
              <label class="form-check-label" for="action_alert_admin">
                <i class="fas fa-bell text-warning"></i> Alert Admin
              </label>
            </div>
            <div class="form-check mb-2">
              <input
                class="form-check-input action-checkbox"
                type="checkbox"
                value="quarantine_traffic"
                id="action_quarantine"
              />
              <label class="form-check-label" for="action_quarantine">
                <i class="fas fa-shield-alt text-info"></i> Quarantine Traffic
              </label>
            </div>
            <div class="form-check mb-2">
              <input
                class="form-check-input action-checkbox"
                type="checkbox"
                value="enable_captcha"
                id="action_captcha"
              />
              <label class="form-check-label" for="action_captcha">
                <i class="fas fa-check-square text-info"></i> Enable CAPTCHA
              </label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-check mb-2">
              <input
                class="form-check-input action-checkbox"
                type="checkbox"
                value="log_incident"
                id="action_log"
              />
              <label class="form-check-label" for="action_log">
                <i class="fas fa-file-alt text-secondary"></i> Log Incident
              </label>
            </div>
            <div class="form-check mb-2">
              <input
                class="form-check-input action-checkbox"
                type="checkbox"
                value="monitor"
                id="action_monitor"
              />
              <label class="form-check-label" for="action_monitor">
                <i class="fas fa-eye text-secondary"></i> Monitor
              </label>
            </div>
            <div class="form-check mb-2">
              <input
                class="form-check-input action-checkbox"
                type="checkbox"
                value="investigate"
                id="action_investigate"
              />
              <label class="form-check-label" for="action_investigate">
                <i class="fas fa-search text-primary"></i> Investigate
              </label>
            </div>
          </div>
        </div>

        {{ form.actions(class="d-none", id="actionsJson") }} {% if
        form.actions.errors %}
        <div class="text-danger small mt-1">
          {% for error in form.actions.errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- Priority and Severity -->
      <div class="row">
        <div class="col-md-3">
          <div class="mb-3">
            {{ form.priority.label(class="form-label") }} {{
            form.priority(class="form-select" + (" is-invalid" if
            form.priority.errors else "")) }} {% if form.priority.errors %}
            <div class="invalid-feedback">
              {% for error in form.priority.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
        <div class="col-md-3">
          <div class="mb-3">
            {{ form.severity_score.label(class="form-label") }} {{
            form.severity_score(class="form-control" + (" is-invalid" if
            form.severity_score.errors else "")) }} {% if
            form.severity_score.errors %}
            <div class="invalid-feedback">
              {% for error in form.severity_score.errors %}{{ error }}{% endfor
              %}
            </div>
            {% endif %}
          </div>
        </div>
        <div class="col-md-3">
          <div class="mb-3">
            {{ form.match_threshold.label(class="form-label") }} {{
            form.match_threshold(class="form-control" + (" is-invalid" if
            form.match_threshold.errors else "")) }} {% if
            form.match_threshold.errors %}
            <div class="invalid-feedback">
              {% for error in form.match_threshold.errors %}{{ error }}{% endfor
              %}
            </div>
            {% endif %}
            <small class="form-text text-muted"
              >% of conditions that must match</small
            >
          </div>
        </div>
        <div class="col-md-3">
          <div class="mb-3 mt-4">
            <div class="form-check">
              {{ form.is_active(class="form-check-input") }} {{
              form.is_active.label(class="form-check-label") }}
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        {{ form.submit(class="btn btn-primary") }}
        <a
          href="{{ url_for('rules.detail', rule_id=rule.id) }}"
          class="btn btn-outline-secondary"
          >Cancel</a
        >
      </div>
    </form>
  </div>
</div>

<script>
  // Rule Form Builder Logic for Edit
  let conditionCounter = 0;
  const existingConditions = {{ (rule.conditions | tojson) if rule else '{}' }};
  const existingActions = {{ (rule.actions | tojson) if rule else '[]' }};

  function createConditionRow(key = '', operator = '>=', value = '') {
    conditionCounter++;
    const div = document.createElement('div');
    div.className = 'condition-row mb-2';
    div.dataset.id = conditionCounter;

    div.innerHTML = `
      <div class="row g-2 align-items-center">
        <div class="col-md-3">
          <input type="text" class="form-control form-control-sm condition-key" placeholder="Field name" value="${key}" />
        </div>
        <div class="col-md-2">
          <select class="form-select form-select-sm condition-operator">
            <option value=">=" ${operator === '>=' ? 'selected' : ''}>Greater or Equal (>=)</option>
            <option value="<=" ${operator === '<=' ? 'selected' : ''}>Less or Equal (<=)</option>
            <option value=">" ${operator === '>' ? 'selected' : ''}>Greater Than (>)</option>
            <option value="<" ${operator === '<' ? 'selected' : ''}>Less Than (<)</option>
            <option value="==" ${operator === '==' ? 'selected' : ''}>Equals (==)</option>
            <option value="equals" ${operator === 'equals' ? 'selected' : ''}>Text Equals</option>
            <option value="boolean" ${operator === 'boolean' ? 'selected' : ''}>Boolean</option>
          </select>
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control form-control-sm condition-value" placeholder="Value" value="${value}" />
        </div>
        <div class="col-md-3">
          <small class="text-muted condition-hint">Enter value</small>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-sm btn-outline-danger remove-condition" onclick="removeCondition(${conditionCounter})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `;

    document.getElementById('conditionsContainer').appendChild(div);
    updateConditionsJson();
  }

  function removeCondition(id) {
    const row = document.querySelector(`[data-id="${id}"]`);
    if (row) {
      row.remove();
      updateConditionsJson();
    }
  }

  function updateConditionsJson() {
    const conditions = {};
    document.querySelectorAll('.condition-row').forEach(row => {
      const key = row.querySelector('.condition-key').value.trim();
      const operator = row.querySelector('.condition-operator').value;
      const value = row.querySelector('.condition-value').value.trim();

      if (key && value) {
        if (operator === 'boolean') {
          conditions[key] = value.toLowerCase() === 'true';
        } else if (operator === 'equals') {
          conditions[key] = value;
        } else {
          conditions[key] = `${operator} ${value}`;
        }
      }
    });

    document.getElementById('conditionsJson').value = JSON.stringify(conditions);
  }

  function updateActionsJson() {
    const actions = [];
    document.querySelectorAll('.action-checkbox:checked').forEach(checkbox => {
      actions.push(checkbox.value);
    });

    document.getElementById('actionsJson').value = JSON.stringify(actions);
  }

  // Load existing conditions
  for (const [key, condValue] of Object.entries(existingConditions)) {
    let operator = 'equals';
    let value = condValue;

    if (typeof condValue === 'boolean') {
      operator = 'boolean';
      value = condValue.toString();
    } else if (typeof condValue === 'string' && condValue.includes(' ')) {
      const parts = condValue.split(' ');
      operator = parts[0];
      value = parts.slice(1).join(' ');
    }

    createConditionRow(key, operator, value);
  }

  // Load existing actions
  existingActions.forEach(action => {
    const checkbox = document.getElementById(`action_${action}`);
    if (checkbox) checkbox.checked = true;
  });

  // Event Listeners
  document.getElementById('addConditionBtn').addEventListener('click', () => createConditionRow());

  document.querySelectorAll('.action-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateActionsJson);
  });

  document.getElementById('conditionsContainer').addEventListener('input', updateConditionsJson);
  document.getElementById('conditionsContainer').addEventListener('change', updateConditionsJson);

  document.getElementById('ruleForm').addEventListener('submit', function(e) {
    updateConditionsJson();
    updateActionsJson();

    const conditionsValue = document.getElementById('conditionsJson').value;
    const actionsValue = document.getElementById('actionsJson').value;

    if (!conditionsValue || conditionsValue === '{}') {
      e.preventDefault();
      alert('Please add at least one condition!');
      return false;
    }

    if (!actionsValue || actionsValue === '[]') {
      e.preventDefault();
      alert('Please select at least one action!');
      return false;
    }
  });

  // Initialize JSON fields
  updateConditionsJson();
  updateActionsJson();
</script>
{% endblock %}
